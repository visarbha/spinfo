#!/usr/bin/env python3

from spi import proto
from spi import spiDisplay

srvcDbFile = '/etc/services'

class service(proto.tcp,proto.udp,spiDisplay.msg):
    def __init__(self,srvc,proto="allproto"):
        self._srvc = srvc
        self._proto = proto
    def fetch(self):
        self.fields("srvc")
        for s in self._srvc:
            srvcInfo = list()
            approx = "no"
            if s.startswith('~'):
                approx = "yes"
                s = s[1:]
            for line in open(srvcDbFile):
                if line:
                    if not line.startswith('#'):
                        if approx == "yes":
                            if line.find(s) >= 0:
                                srvcInfo.append(line)
                        elif approx == "no":
                            ns = s + " "
                            if line.find(ns) == 0:
                                srvcInfo.append(line)
            if self._proto == "tcp":
                if len(self.tcpFilter(srvcInfo)) > 0:
                    self.info("srvc",self.tcpFilter(srvcInfo))
                else:
                    self.noInfo("srvc",srvc=s,proto="tcp")
            elif self._proto == "udp":
                if len(self.udpFilter(srvcInfo)) > 0:
                    self.info("srvc",self.udpFilter(srvcInfo))
                else:
                    self.noInfo("srvc",srvc=s,proto="udp")
            elif self._proto == "allproto":
                if len(srvcInfo) > 0:
                    self.info("srvc",srvcInfo)
                else:
                    self.noInfo("srvc",srvc=s)
        print()

class port(proto.tcp,proto.udp,spiDisplay.msg):
    def __init__(self,port,proto="allproto"):
        self._port = port
        self._proto = proto
    def fetch(self):
        self.fields("port")
        for p in self._port:
            portInfo = list()
            approx = "no"
            if p.startswith('~'):
                approx = "yes"
                p = p[1:]
            for line in open(srvcDbFile):
                if line:
                    if not line.startswith('#'):
                        if approx == "no":
                            fs = " " + p + "/"
                        else:
                            fs = p
                        if line.find(fs) > 0:
                            portInfo.append(line)
            if len(portInfo) > 0:
                if self._proto == "tcp":
                    if len(self.tcpFilter(portInfo)) > 0:
                        self.info("port",self.tcpFilter(portInfo))
                    else:
                        self.info(self.noInfo("port",port=p,proto="tcp"))
                elif self._proto == "udp":
                    if len(self.udpFilter(portInfo)) > 0:
                        self.info("port",self.udpFilter(portInfo))
                    else:
                        self.noInfo("port",port=p,proto="udp")
                elif self._proto == "allproto":
                    self.info("port",portInfo)
            else:
                self.noInfo("port",port=p)
        print()
